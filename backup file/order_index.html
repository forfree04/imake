<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>imake - Modal & Logic Fixed</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { --primary: #3b82f6; --bg: #f8fafc; --text: #1e293b; --danger: #ef4444; --success: #10b981; --border: #f1f5f9; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: "Pretendard Variable", Pretendard, sans-serif; -webkit-user-select: none; user-select: none; }
        
        body { background: #cbd5e1; display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow: hidden; }
        .iphone-mockup { width: 375px; height: 812px; background: white; border: 12px solid #111; border-radius: 50px; position: relative; overflow: hidden; box-shadow: 0 40px 80px rgba(0,0,0,0.5); display: flex; flex-direction: column; }
        @media screen and (max-width: 500px) { body { background: white; } .iphone-mockup { width: 100vw; height: 100vh; border: none; border-radius: 0; box-shadow: none; } }

        /* [HEADER] 3Î∂ÑÌï† Í≥†Ï†ï (z-index: 1000) */
        header { 
            display: grid; grid-template-columns: 1fr 1fr 1fr; align-items: center; 
            height: 60px; padding: 0 15px; border-bottom: 1px solid var(--border); 
            background: white; z-index: 1000; position: relative; 
        }
        .header-left { display: flex; justify-content: flex-start; }
        .header-center { display: flex; justify-content: center; align-items: center; gap: 5px; font-weight: 800; color: var(--primary); cursor: pointer; white-space: nowrap; }
        .header-right { display: flex; justify-content: flex-end; align-items: center; }
        .logo { font-weight: 900; font-style: italic; color: var(--primary); font-size: 20px; cursor: pointer; }
        .header-btn { border: none; background: none; cursor: pointer; color: var(--text); padding: 8px; display: flex; align-items: center; justify-content: center; }

        /* [HELP SYSTEM] ÏÉÅÎã® ÎπÑÏπ® Î∞©ÏßÄ */
        .help-system { 
            position: absolute; top: 60px; left: 0; width: 100%; z-index: 900; 
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); transform: translateY(-100%); 
        }
        .help-system.open { transform: translateY(0); }
        .help-panel { 
            background: white; padding: 20px; border-bottom: 3px solid var(--primary); 
            display: flex; flex-direction: column; gap: 12px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); 
        }
        .help-tab { 
            width: 80px; height: 26px; background: var(--primary); color: white; 
            position: absolute; bottom: -26px; left: 50%; transform: translateX(-50%); 
            display: flex; justify-content: center; align-items: center; 
            border-bottom-left-radius: 10px; border-bottom-right-radius: 10px; 
            cursor: pointer; font-size: 10px; font-weight: 900; z-index: 1100; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        }

        /* SCREENS - z-index ÏµúÏÉÅÏúÑ Ïú†ÏßÄ */
        #screen-home { flex: 1; display: flex; flex-direction: column; background: var(--bg); position: relative; padding: 15px; overflow-y: auto; padding-bottom: 100px; }
        #screen-home::-webkit-scrollbar { display: none; }
        #screen-table, #screen-menu, #screen-owner, #screen-waiting, #screen-mypage { 
            flex: 1; display: none; flex-direction: column; background: white; 
            z-index: 2000; position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
        }
        #screen-table { align-items: center; justify-content: center; background: #f8fafc; }
        #screen-owner { align-items: center; justify-content: center; background: #1e293b; color: white; text-align: center; z-index: 3000; }
        #screen-waiting { align-items: center; justify-content: center; text-align: center; z-index: 3000; }
        #screen-mypage { background: #f8fafc; padding: 20px; z-index: 2000; }

        /* UI ELEMENTS */
        .dashboard { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px; }
        .dash-card { background: white; padding: 12px 5px; border-radius: 15px; border: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .dash-count { font-size: 16px; font-weight: 900; color: var(--primary); }
        .dash-title { font-size: 8px; font-weight: 800; color: #94a3b8; }
        .category-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px; }
        .cat-item { background: white; border-radius: 12px; padding: 10px; display: flex; align-items: center; justify-content: center; gap: 6px; border: 1px solid var(--border); cursor: pointer; }
        .cat-name { font-size: 9px; font-weight: 800; }
        .map-section { width: 100%; height: 160px; background: #e0f2fe; border-radius: 20px; position: relative; margin-bottom: 15px; border: 2px solid white; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .marker { position: absolute; width: 12px; height: 12px; background: var(--primary); border: 2px solid white; border-radius: 50%; transition: 0.4s; }
        .rec-scroll { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
        .rec-card { flex: 0 0 160px; background: white; border-radius: 20px; overflow: hidden; border: 1px solid var(--border); cursor: pointer; position: relative; }
        .rec-img { width: 100%; height: 90px; object-fit: cover; }
        .rec-info { padding: 10px; display: flex; justify-content: space-between; align-items: center; }
        .rec-name { font-size: 11px; font-weight: 800; color: var(--text); }
        .status-badge { position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.95); backdrop-filter: blur(4px); padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: 800; display: flex; align-items: center; gap: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; }

        /* ORDER UI */
        .ticket-icon { width: 120px; height: 120px; background: white; border: 2px dashed #cbd5e1; border-radius: 12px; display: flex; justify-content: center; align-items: center; margin-bottom: 20px; font-size: 60px; font-weight: 900; color: var(--primary); }
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 100%; max-width: 280px; }
        .num-btn { background: white; border: 1px solid #e2e8f0; border-radius: 15px; height: 60px; font-size: 24px; font-weight: 600; cursor: pointer; display: flex; justify-content: center; align-items: center; box-shadow: 0 2px 0 #cbd5e1; }
        .num-btn.confirm { background: var(--primary); color: white; grid-column: span 3; margin-top: 10px; border: none; }

        /* MENU LIST */
        .menu-list { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 100px; }
        .menu-item { display: flex; gap: 15px; padding: 15px 0; border-bottom: 1px solid #f1f5f9; }
        .menu-img { width: 80px; height: 80px; border-radius: 12px; background: #eee; object-fit: cover; }
        .menu-info { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .old-price { font-size: 12px; color: #94a3b8; text-decoration: line-through; }
        .new-price { font-size: 16px; font-weight: 800; color: #ef4444; }
        .discount-badge { font-size: 10px; background: #fee2e2; color: #ef4444; padding: 2px 5px; border-radius: 4px; margin-left: 5px; }
        .qty-ctrl { display: flex; align-items: center; gap: 10px; margin-top: 8px; }
        .qty-btn { width: 24px; height: 24px; border-radius: 50%; border: 1px solid #cbd5e1; background: white; display: flex; justify-content: center; align-items: center; cursor: pointer; }
        
        /* CART & FLOATING */
        .cart-bar { position: absolute; bottom: 0; width: 100%; background: white; padding: 20px; border-top: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 -4px 10px rgba(0,0,0,0.05); z-index: 50; }
        .order-btn { background: var(--primary); color: white; padding: 12px 20px; border-radius: 12px; font-weight: 800; border: none; cursor: pointer; font-size: 16px; }
        .order-btn:disabled { background: #cbd5e1; }
        .bill-btn { font-size: 12px; font-weight: bold; color: var(--primary); border: 1px solid var(--primary); padding: 5px 10px; border-radius: 20px; display: flex; align-items: center; gap: 4px; cursor: pointer; }
        .floating-order-btn { position: absolute; bottom: 100px; right: 20px; background: #1e293b; color: white; padding: 12px 20px; border-radius: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); display: none; align-items: center; gap: 8px; cursor: pointer; z-index: 500; animation: float 3s infinite ease-in-out; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-5px); } 100% { transform: translateY(0px); } }

        /* MODAL SYSTEM (Ïò§Î•∏Ï™Ω Ï†ïÏÉÅ Ïù¥ÎØ∏ÏßÄÏôÄ ÎèôÏùºÌïú CSS Ï†ÅÏö©) */
        .modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 5000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-box { background: white; width: 90%; padding: 25px; border-radius: 25px; text-align: center; max-height: 80%; overflow-y: auto; font-size: 14px; position: relative; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; min-height: 24px; }
        .modal-header h3 { font-size: 16px; font-weight: 800; color: var(--text); margin: 0; flex: 1; text-align: center; }
        .modal-header-btn { border: none; background: none; color: #94a3b8; cursor: pointer; padding: 5px; width: 30px; display: flex; align-items: center; justify-content: center; }
        
        .m-btn { flex: 1; padding: 15px; border-radius: 18px; font-weight: bold; border: none; cursor: pointer; font-size: 14px; }
        .m-confirm { background: var(--primary); color: white; }
        .m-cancel { background: #f1f5f9; color: #64748b; }
        .modal-btns { display: flex; gap: 12px; margin-top: 25px; width: 100%; }

        /* LIST & MISC */
        .action-sheet-btn { width: 100%; padding: 15px; border-radius: 15px; border: 1px solid var(--border); background: white; margin-bottom: 10px; display: flex; align-items: center; gap: 12px; font-weight: 700; cursor: pointer; }
        .list-item { display: flex; align-items: center; gap: 10px; padding: 10px 0; border-bottom: 1px solid #f8fafc; text-align: left; }
        .check-box { width: 22px; height: 22px; border: 2px solid #cbd5e1; border-radius: 8px; cursor: pointer; }
        .check-box.checked { background: var(--primary); border-color: var(--primary); display: flex; align-items: center; justify-content: center; }
        .check-box.checked::after { content: '‚úì'; color: white; font-size: 12px; font-weight: bold; }
        .cat-chip { font-size: 9px; font-weight: 800; color: var(--primary); background: #eff6ff; padding: 2px 6px; border-radius: 6px; margin-right: 4px; }
        .bill-list-item { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 6px; color: #475569; }
        .bill-total { display: flex; justify-content: space-between; font-size: 18px; font-weight: 900; color: #1e293b; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #cbd5e1; }
        
        .bottom-nav { position: absolute; bottom: 0; width: 100%; height: 85px; background: rgba(255, 255, 255, 0.96); border-top: 1px solid var(--border); display: flex; justify-content: space-around; align-items: center; padding-bottom: 20px; z-index: 100; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: #94a3b8; border: none; background: none; flex: 1; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        .nav-item span { font-size: 9px; font-weight: 800; }

        .blink-bg { animation: blinkRed 1s infinite; }
        @keyframes blinkRed { 0% { background-color: #1e293b; } 50% { background-color: #ef4444; } 100% { background-color: #1e293b; } }
    </style>
</head>
<body>
    <div class="iphone-mockup">
        <header id="main-header">
            <div class="header-left"><div class="logo" onclick="location.reload()">imake</div></div>
            <div class="header-center" onclick="openModal('qr')"><i data-lucide="qr-code" style="width:18px;"></i><span>My QR</span></div>
            <div class="header-right">
                <button class="header-btn" onclick="openLangModal()"><i data-lucide="globe"></i></button>
                <button class="header-btn" onclick="alert('Menu Opened')"><i data-lucide="menu"></i></button>
            </div>
        </header>

        <div id="helpBox" class="help-system">
            <div class="help-panel">
                <button style="width:100%; padding:16px; background:var(--primary); color:white; border:none; border-radius:14px; font-weight:bold; cursor:pointer;" onclick="window.location.href='tel:1330'">üìû Call 1330 Tourism Info</button>
                <div style="font-size: 11px; font-weight: 900; color: var(--primary); margin-top: 5px;">AI TRANSLATOR</div>
                <div style="background:#f1f5f9; padding:12px; border-radius:12px; margin-bottom:10px;"><textarea placeholder="Type to translate..." style="width:100%; border:none; background:none; outline:none; height:45px; resize:none; font-size:13px; color:var(--text);"></textarea></div>
                <div style="font-size: 11px; font-weight: 900; color: var(--primary);">TRAVEL TIPS</div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-bottom:10px;">
                    <button onclick="showTip('Dining')" style="background:white; border:1px solid var(--border); padding:10px; border-radius:10px; font-size:11px; font-weight:700; color:var(--primary);">üç¥ Dining</button>
                    <button onclick="showTip('Transport')" style="background:white; border:1px solid var(--border); padding:10px; border-radius:10px; font-size:11px; font-weight:700; color:var(--primary);">üöå Transport</button>
                    <button onclick="showTip('Stay')" style="background:white; border:1px solid var(--border); padding:10px; border-radius:10px; font-size:11px; font-weight:700; color:var(--primary);">üè® Stay</button>
                    <button onclick="showTip('Manner')" style="background:white; border:1px solid var(--border); padding:10px; border-radius:10px; font-size:11px; font-weight:700; color:var(--primary);">üòä Manner</button>
                </div>
                <button style="width:100%; padding:16px; background:var(--danger); color:white; border:none; border-radius:14px; font-weight:bold; cursor:pointer;" onclick="alert('üìç SOS Sent!')">üìç My Location / SOS Send</button>
            </div>
            <div class="help-tab" onclick="document.getElementById('helpBox').classList.toggle('open')">HELP ‚ñæ</div>
        </div>

        <div id="screen-home">
            <main id="main-content-area">
                <div class="dashboard">
                    <div class="dash-card" onclick="openModal('todo')"><span class="dash-title">TOTAL TO DO</span><span id="todoCount" class="dash-count">0</span></div>
                    <div class="dash-card" onclick="openModal('fav')"><span class="dash-title">FAVORITES</span><span id="favCount" class="dash-count">0</span></div>
                    <div class="dash-card" onclick="openModal('sch')"><span class="dash-title">TODAY SCH</span><span id="schCount" class="dash-count">0</span></div>
                </div>
                <div class="category-grid">
                    <div class="cat-item" onclick="filterContent('Food','#ef4444')"><i data-lucide="utensils" style="width:14px;"></i><span class="cat-name">Food</span></div>
                    <div class="cat-item" onclick="filterContent('Cafe','#f59e0b')"><i data-lucide="coffee" style="width:14px;"></i><span class="cat-name">Cafe</span></div>
                    <div class="cat-item" onclick="filterContent('Conv','#10b981')"><i data-lucide="store" style="width:14px;"></i><span class="cat-name">Conv</span></div>
                    <div class="cat-item" onclick="filterContent('Hair','#8b5cf6')"><i data-lucide="scissors" style="width:14px;"></i><span class="cat-name">Hair</span></div>
                    <div class="cat-item" onclick="filterContent('Activity','#3b82f6')"><i data-lucide="ticket" style="width:14px;"></i><span class="cat-name">Act</span></div>
                    <div class="cat-item" onclick="filterContent('Shop','#ec4899')"><i data-lucide="shopping-bag" style="width:14px;"></i><span class="cat-name">Shop</span></div>
                </div>
                <div class="map-section"><div class="marker" id="m1" style="top:50px; left:120px;"></div><div style="z-index:10; background:rgba(255,255,255,0.9); padding:6px 12px; border-radius:10px; font-size:10px; font-weight:800; color:var(--primary);">Smart Guide Map</div></div>
                <div id="recTitle" style="font-size: 14px; font-weight: 900; margin-bottom: 12px;">Recommended</div>
                <div id="recScroll" class="rec-scroll"></div>
            </main>
            <nav class="bottom-nav">
                <button class="nav-item active"><i data-lucide="home"></i><span>Home</span></button>
                <button class="nav-item" onclick="openModal('products')"><i data-lucide="shopping-cart"></i><span>Shop</span></button>
                <button class="nav-item" onclick="startQRScan()"><i data-lucide="scan-line"></i><span>Order</span></button>
                <button class="nav-item" onclick="openModal('fav')"><i data-lucide="star"></i><span>Favs</span></button>
                <button class="nav-item" onclick="openMyHistory()"><i data-lucide="user"></i><span>My</span></button>
            </nav>
        </div>

        <div id="floatBtn" class="floating-order-btn" onclick="restoreOrderScreen()"><i data-lucide="utensils" style="width:16px;"></i><span style="font-size:12px; font-weight:bold;">Table <span id="floatTableNum">--</span></span></div>

        <div id="screen-table">
            <header style="width:100%; display:flex; justify-content:space-between; align-items:center; padding:0 15px; height:60px; background:white;">
                <button class="header-btn" onclick="minimizeOrder()"><i data-lucide="chevron-down"></i></button>
                <span style="font-weight:bold;">imake Order</span><div style="width:30px;"></div>
            </header>
            <div style="font-size: 16px; font-weight: 700; margin: 30px 0; color: #64748b; text-align: center;">Î≤àÌò∏ÌëúÏùò Ïà´ÏûêÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî</div>
            <div class="ticket-icon" id="ticketDisplay">--</div>
            <div class="numpad">
                <button class="num-btn" onclick="inputNum(1)">1</button><button class="num-btn" onclick="inputNum(2)">2</button><button class="num-btn" onclick="inputNum(3)">3</button>
                <button class="num-btn" onclick="inputNum(4)">4</button><button class="num-btn" onclick="inputNum(5)">5</button><button class="num-btn" onclick="inputNum(6)">6</button>
                <button class="num-btn" onclick="inputNum(7)">7</button><button class="num-btn" onclick="inputNum(8)">8</button><button class="num-btn" onclick="inputNum(9)">9</button>
                <button class="num-btn" onclick="inputNum('C')" style="color:#ef4444">C</button><button class="num-btn" onclick="inputNum(0)">0</button><button class="num-btn" onclick="inputNum('BS')">‚Üê</button>
                <button class="num-btn confirm" onclick="checkTableNum()">ÏûÖÎ†• ÏôÑÎ£å</button>
            </div>
        </div>

        <div id="screen-menu">
            <header style="display:flex; justify-content:space-between; align-items:center; padding:0 15px; height:60px; background:white;">
                <button class="header-btn" onclick="minimizeOrder()"><i data-lucide="home"></i></button>
                <span>Table <span id="headerTableNum" style="color:var(--primary); font-weight: 900;"></span></span>
                <button class="header-btn" onclick="openBillModal()"><i data-lucide="receipt"></i></button>
            </header>
            <div class="menu-list" id="orderMenuList"></div>
            <div class="cart-bar">
                <div class="total-price" style="font-weight:900;">‚Ç© <span id="totalPrice">0</span></div>
                <button class="order-btn" id="btnOrder" onclick="openOrderSummary()" disabled>Ï£ºÎ¨∏ÌïòÍ∏∞</button>
            </div>
        </div>

        <div id="screen-owner">
            <h2 style="margin-bottom:20px;">üõéÔ∏è KITCHEN MONITOR</h2>
            <div id="ownerMsg" style="margin-bottom:20px; font-size:14px; opacity:0.8;">Waiting for orders...</div>
            <div id="kitchenCard" style="display:none; background:white; padding:25px; border-radius:20px; color:var(--text); width:90%; border:1px solid #eee;">
                <div style="font-size:30px; font-weight:900; color:#ef4444; margin-bottom:10px;">TABLE <span id="kitchenTableNum"></span></div>
                <div id="kitchenOrderList" style="text-align:left; background:#f8fafc; padding:15px; border-radius:10px; margin-bottom:15px; font-size:14px; font-weight:bold; line-height: 1.6;"></div>
                <div style="font-size:12px; color:gray; margin-bottom:15px;" id="timerText">Elapsed: 0s</div>
                <button style="width:100%; padding:16px; background:var(--primary); color:white; border:none; border-radius:14px; font-weight:bold; cursor:pointer;" onclick="confirmOrderKitchen()">‚úÖ Ï£ºÎ¨∏ ÌôïÏù∏ (Accept)</button>
            </div>
        </div>

        <div id="screen-waiting">
            <div style="width: 80px; height: 80px; background: #eff6ff; border-radius: 50%; display: flex; justify-content: center; align-items: center; color: var(--primary); margin: 0 auto 20px; animation: pulse 1.5s infinite;"><i data-lucide="send" style="width:30px;"></i></div>
            <h3 style="margin-bottom:10px;">Sending Order...</h3>
            <p style="color:#64748b; font-size:14px;">Waiting for confirmation</p>
        </div>

        <div id="screen-mypage">
            <header style="display:flex; justify-content:space-between; align-items:center; background:white; padding:0 15px; height:60px;">
                <button class="header-btn" onclick="document.getElementById('screen-mypage').style.display='none'"><i data-lucide="arrow-left"></i></button>
                <span>History</span><div style="width:30px;"></div>
            </header>
            <div id="historyList" style="padding:10px 20px;"></div>
            <button style="margin:20px; width:90%; padding:16px; background:#f1f5f9; color:#64748b; border:none; border-radius:18px; font-weight:bold; cursor:pointer;" onclick="location.reload()">Reset Demo</button>
        </div>

        <div id="modalOverlay" class="modal-overlay" onclick="closeModal()">
            <div id="modalContent" class="modal-box" onclick="event.stopPropagation()"></div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        const getToday = () => new Date().toISOString().split('T')[0];

        let currentLang = 'en'; 
        let masterTasks = [{ id: 1, title: "Rent Hanbok", date: "", time: "", completed: false }]; 
        let favorites = [{ id: 101, title: "Gyeongbokgung", cat: "Activity", img: "https://images.unsplash.com/photo-1548115184-bc6544d06a58?w=400", desc: "Main Palace" }];
        let myProducts = [{ id: 501, title: "[GOV] Suwon Pass", desc: "Tourism Discount" }];
        const tips = { 'Dining': 'Lunch peak 11:30~13:00.', 'Transport': 'Tag card twice!', 'Stay': 'Check-in 15:00.', 'Manner': 'No tips!' };
        
        let currentTable = ""; let cart = {}; let confirmedOrders = [];

        const placeDB = { 
            'Food': [{name:'Myeongdong Kyoja',img:'https://images.unsplash.com/photo-1534422298391-e4f8c170db06?w=400',cat:'Food',status:'yellow'},{name:'Gwangjang Market',img:'https://images.unsplash.com/photo-1563127616-52c3f8730b20?w=400',cat:'Food',status:'green'},{name:'Tosokchon',img:'https://images.unsplash.com/photo-1623341214825-9f4f963727da?w=400',cat:'Food',status:'red'},{name:'Jinju Hoegwan',img:'https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?w=400',cat:'Food',status:'green'}],
            'Activity': [{name:'Gyeongbokgung',img:'https://images.unsplash.com/photo-1548115184-bc6544d06a58?w=400',cat:'Act',status:'green'},{name:'N Tower',img:'https://images.unsplash.com/photo-1538669715515-583b15746a9a?w=400',cat:'Act',status:'yellow'},{name:'Lotte World',img:'https://images.unsplash.com/photo-1513885535751-8b9238bd345a?w=400',cat:'Act',status:'red'},{name:'Han River',img:'https://images.unsplash.com/photo-1610448721566-47369c768e70?w=400',cat:'Act',status:'green'}]
        };
        const statusMap = { 'green': { color: '#10b981', bg: '#dcfce7', text: 'üü¢ Available' }, 'yellow': { color: '#f59e0b', bg: '#fef3c7', text: 'üü° Busy (<15m)' }, 'red': { color: '#ef4444', bg: '#fee2e2', text: 'üî¥ Full (>30m)' } };
        
        let menuData = [
            { id: 1, name: { ko: "ÏàòÏõê ÏôïÍ∞àÎπÑ ÌÜµÎã≠", en: "Suwon Galbi Chicken", ja: "Ê∞¥Âéü„Ç´„É´„Éì", zh: "Ê∞¥ÂéüÁÇ∏È∏°" }, price: 22000, img: "https://images.unsplash.com/photo-1563127616-52c3f8730b20?w=200" },
            { id: 2, name: { ko: "ÌõÑÎùºÏù¥Îìú ÏπòÌÇ®", en: "Fried Chicken", ja: "„Éï„É©„Ç§„Éâ", zh: "ÁÇ∏È∏°" }, price: 19000, img: "https://images.unsplash.com/photo-1626082927389-6cd097cdc6ec?w=200" },
            { id: 3, name: { ko: "ÏΩîÏπ¥ÏΩúÎùº", en: "Coca Cola", ja: "„Ç≥„Éº„É©", zh: "ÂèØ‰πê" }, price: 2500, img: "https://images.unsplash.com/photo-1622483767028-3f66f32aef97?w=200" },
            { id: 4, name: { ko: "ÏÉùÎß•Ï£º (500cc)", en: "Draft Beer", ja: "„Éì„Éº„É´", zh: "Âï§ÈÖí" }, price: 4500, img: "https://images.unsplash.com/photo-1586993451228-09818021e309?w=200" }
        ];

        const translations = {
            ko: { checkTable: "ÏûÖÎ†•ÌïòÏã† Î≤àÌò∏Í∞Ä ÎßûÎÇòÏöî?", checkOrder: "Ï£ºÎ¨∏ÌïòÏãúÍ≤†ÏäµÎãàÍπå?", msgConfirmed: "Ï£ºÎ¨∏ ÏôÑÎ£å!", msgCooking: "ÎßõÏûàÍ≤å Ï°∞Î¶¨ÌïòÍ≤†ÏäµÎãàÎã§.", totalBill: "Ï¥ù Í≥ÑÏÇ∞ÏÑú" },
            en: { checkTable: "Is Table correct?", checkOrder: "Confirm Order?", msgConfirmed: "Order Accepted!", msgCooking: "Preparing your food.", totalBill: "Total Bill" }
        };

        // [MODAL SYSTEM - ÌïµÏã¨: Ìó§ÎçîÏôÄ Îã´Í∏∞Î≤ÑÌäº Î∂ÑÎ¶¨]
        function showModalHTML(html, title = "") { 
            let header = `
                <div class="modal-header">
                    <button class="modal-header-btn" onclick="closeModal()"><i data-lucide="x"></i></button>
                    <h3>${title}</h3>
                    <div style="width:30px;"></div>
                </div>`;
            document.getElementById('modalContent').innerHTML = header + html; document.getElementById('modalOverlay').style.display='flex'; lucide.createIcons(); 
        }
        function closeModal() { document.getElementById('modalOverlay').style.display='none'; }

        // [USER LOGIC]
        function filterContent(cat, color) { 
            document.querySelectorAll('.marker').forEach(m => { m.style.background = color; m.style.left = Math.random()*200+50+"px"; }); 
            const items = placeDB[cat] || placeDB['Activity'];
            document.getElementById('recScroll').innerHTML = items.map(i => {
                const st = statusMap[i.status] || statusMap['green'];
                return `<div class="rec-card" onclick="openActionSheet('${i.name}', '${i.cat}', '${i.img}', '${i.status}')"><img src="${i.img}" class="rec-img"><div class="status-badge"><div class="status-dot" style="background:${st.color}"></div><span>${i.status}</span></div><div class="rec-info"><div class="rec-name">${i.name}</div><i data-lucide="more-vertical" style="width:14px; color:#cbd5e1;"></i></div></div>`;
            }).join('');
            lucide.createIcons();
        }

        function openActionSheet(name, cat, img, status) {
            const isFav = favorites.some(f => f.title === name);
            const stInfo = statusMap[status] || statusMap['green'];
            showModalHTML(`<img src="${img}" style="width:100%; border-radius:15px; margin-bottom:15px;"><h3>${name}</h3><div style="background:${stInfo.bg}; color:${stInfo.color}; padding:10px; border-radius:10px; margin-bottom:10px; font-weight:bold; text-align:center;">${stInfo.text}</div><button class="action-sheet-btn" onclick="addToTodo('${name}')">To Do List</button><button class="action-sheet-btn" onclick="toggleFavorite('${name}','${cat}','${img}')"><i data-lucide="star" style="fill:${isFav?'var(--primary)':'none'}"></i> ${isFav?'Unfavorite':'Favorite'}</button>`, name);
        }

        function addToTodo(name) { masterTasks.push({ id: Date.now(), title: name, completed: false }); updateDash(); closeModal(); }
        function toggleFavorite(name, cat, img) { const idx = favorites.findIndex(f => f.title === name); if (idx > -1) favorites.splice(idx,1); else favorites.push({id:Date.now(),title:name,cat,img}); updateDash(); filterContent(cat,'#3b82f6'); closeModal(); }
        function updateDash() { document.getElementById('todoCount').innerText = masterTasks.length; document.getElementById('favCount').innerText = favorites.length; }

        // [ORDER SYSTEM - ÏôÑÎ≤Ω Î≥µÍµ¨]
        function startQRScan() { document.getElementById('screen-table').style.display = 'flex'; }
        function minimizeOrder() { document.getElementById('screen-table').style.display='none'; document.getElementById('screen-menu').style.display='none'; if(currentTable) { document.getElementById('floatBtn').style.display='flex'; document.getElementById('floatTableNum').innerText = currentTable; } }
        function restoreOrderScreen() { document.getElementById('floatBtn').style.display='none'; document.getElementById('screen-menu').style.display='flex'; }
        function inputNum(val) { if(val === 'C') currentTable = ""; else if(val === 'BS') currentTable = currentTable.slice(0, -1); else if(currentTable.length < 2) currentTable += val; document.getElementById('ticketDisplay').innerText = currentTable || "--"; }
        
        // [ÏàòÏ†ï Ìè¨Ïù∏Ìä∏: ÌÖåÏù¥Î∏î Î≤àÌò∏ ÌôïÏù∏ Î™®Îã¨]
        function checkTableNum() { 
            if(!currentTable) return; 
            const html = `
                <h3 style="margin-bottom: 20px;">${translations[currentLang].checkTable}</h3>
                <div style="font-size: 50px; font-weight: 900; color: var(--primary); margin: 30px 0;">${currentTable}</div>
                <div class="modal-btns">
                    <button class="m-btn m-cancel" onclick="closeModal()">ÏàòÏ†ï</button>
                    <button class="m-btn m-confirm" onclick="goToMenu()">OK</button>
                </div>
            `;
            // showModalHTML ÎåÄÏã† ÏßÅÏ†ë Ï°∞ÏûëÌïòÏó¨ ÏôÑÎ≤ΩÌïú ÏõêÎ≥∏ Ïä§ÌÉÄÏùº Íµ¨ÌòÑ
            document.getElementById('modalContent').innerHTML = `
                <div class="modal-header"><button class="modal-header-btn" onclick="closeModal()"><i data-lucide="x"></i></button><div></div><div></div></div>
                ${html}`;
            document.getElementById('modalOverlay').style.display='flex';
            lucide.createIcons();
        }

        function goToMenu() { closeModal(); document.getElementById('screen-table').style.display='none'; document.getElementById('screen-menu').style.display='flex'; document.getElementById('headerTableNum').innerText = currentTable; renderOrderMenu(); }
        function renderOrderMenu() { document.getElementById('orderMenuList').innerHTML = menuData.map(m => `<div class="menu-item"><img src="${m.img}" class="menu-img"><div class="menu-info"><div>${m.name.en}</div><div style="font-weight:bold;">‚Ç© ${Math.floor(m.price*0.95).toLocaleString()}</div><div class="qty-ctrl"><button class="qty-btn" onclick="updateQty(${m.id}, -1)">-</button><span id="qty-${m.id}">${cart[m.id]||0}</span><button class="qty-btn" onclick="updateQty(${m.id}, 1)">+</button></div></div></div>`).join(''); }
        function updateQty(id, chg) { if(!cart[id]) cart[id]=0; cart[id]+=chg; if(cart[id]<0) cart[id]=0; document.getElementById(`qty-${id}`).innerText=cart[id]; calcTotal(); }
        function calcTotal() { let t=0, c=0; for(let id in cart) { const m=menuData.find(x=>x.id==id); if(m) t+=Math.floor(m.price*0.95)*cart[id]; c+=cart[id]; } document.getElementById('totalPrice').innerText=t.toLocaleString(); document.getElementById('btnOrder').disabled = c===0; return t; }

        function openOrderSummary() {
            let html = `<div style="text-align:left; margin-bottom:20px;">`;
            for(let id in cart) if(cart[id]>0) { const m=menuData.find(x=>x.id==id); html+=`<div class="bill-list-item"><span>${m.name.en} x ${cart[id]}</span><span>‚Ç© ${(Math.floor(m.price*0.95)*cart[id]).toLocaleString()}</span></div>`; }
            html += `</div><div class="bill-total"><span>Total</span><span style="color:#ef4444;">‚Ç© ${calcTotal().toLocaleString()}</span></div>`;
            html += `<div class="modal-btns"><button class="m-btn m-cancel" onclick="closeModal()">ÏàòÏ†ï</button><button class="m-btn m-confirm" onclick="submitOrder()">Submit</button></div>`;
            showModalHTML(html, "Confirm Order");
        }

        function openBillModal() {
            let html = `<h3>Total Bill</h3><div style="text-align:left; margin-top:20px;">`, gt=0;
            if(confirmedOrders.length>0) confirmedOrders.forEach(o=>{html+=`<div class="bill-list-item"><span>${o.name} x ${o.qty}</span><span>‚Ç© ${o.totalPrice.toLocaleString()}</span></div>`; gt+=o.totalPrice;});
            let ct=0, ch=""; for(let id in cart) if(cart[id]>0) { const m=menuData.find(x=>x.id==id); const p=Math.floor(m.price*0.95)*cart[id]; ch+=`<div class="bill-list-item" style="color:#3b82f6"><span>[New] ${m.name.en} x ${cart[id]}</span><span>‚Ç© ${p.toLocaleString()}</span></div>`; ct+=p; }
            if(ch) html+=`<div class="bill-divider"></div>`+ch;
            html+=`</div><div class="bill-total"><span>Total</span><span style="color:#ef4444;">‚Ç© ${(gt+ct).toLocaleString()}</span></div>`;
            html+=`<div class="modal-btns" style="flex-direction:column"><button class="m-btn m-confirm" onclick="finishEating()">Pay & Finish</button><button class="m-btn m-cancel" onclick="closeModal()">Continue</button></div>`;
            showModalHTML(html, "Your Bill");
        }

        function submitOrder() { closeModal(); document.getElementById('screen-menu').style.display='none'; document.getElementById('screen-waiting').style.display='flex'; setTimeout(()=>{ document.getElementById('screen-waiting').style.display='none'; document.getElementById('screen-owner').style.display='flex'; startKitchenSystem(); },1500); }
        
        let alarmInterval, elapsed=0;
        function startKitchenSystem() {
            document.getElementById('kitchenCard').style.display='block'; document.getElementById('kitchenTableNum').innerText=currentTable;
            let h=""; for(let id in cart) if(cart[id]>0){const m=menuData.find(x=>x.id==id); h+=`<div>${m.name.en} <span style="color:red">x ${cart[id]}</span></div>`;} 
            document.getElementById('kitchenOrderList').innerHTML=h; elapsed=0;
            if(alarmInterval) clearInterval(alarmInterval); 
            alarmInterval=setInterval(()=>{elapsed++; document.getElementById('timerText').innerText=`Elapsed: ${elapsed}s`; if(elapsed>=5) document.getElementById('screen-owner').classList.add('blink-bg');},1000);
        }

        function confirmOrderKitchen() { 
            clearInterval(alarmInterval); document.getElementById('screen-owner').classList.remove('blink-bg');
            for(let id in cart) if(cart[id]>0) { const m=menuData.find(x=>x.id==id); confirmedOrders.push({name:m.name.en, qty:cart[id], totalPrice:Math.floor(m.price*0.95)*cart[id]}); }
            cart={}; renderOrderMenu(); calcTotal(); document.getElementById('screen-owner').style.display='none'; document.getElementById('screen-menu').style.display='flex';
            showModalHTML(`<h3>Order Accepted!</h3><p style="color:gray">Preparing your food.</p>`, "Success");
        }

        function finishEating() { 
            const hBox = document.getElementById('historyList');
            hBox.innerHTML = `<div style="background:white; padding:15px; border-radius:15px; margin-bottom:10px; border:1px solid #e2e8f0; text-align:left;"><div style="font-size:10px; color:gray;">${new Date().toLocaleDateString()}</div><div style="font-weight:bold;">Dining (Table ${currentTable})</div></div>` + hBox.innerHTML;
            currentTable=""; confirmedOrders=[]; cart={}; closeModal(); document.getElementById('screen-menu').style.display='none'; document.getElementById('floatBtn').style.display='none'; document.getElementById('screen-mypage').style.display='flex';
        }

        function openLangModal() { showModalHTML(`<div style="display:flex; flex-direction:column; gap:8px;"><button class="action-sheet-btn">ÌïúÍµ≠Ïñ¥</button><button class="action-sheet-btn">English</button></div>`, "Language"); }
        function showTip(cat) { showModalHTML(`<p style="padding:15px 0; font-size:14px; line-height:1.6;">${tips[cat]}</p>`, `${cat} Tip`); }
        function openModal(type) { 
            if(type==='qr') showModalHTML(`<i data-lucide="qr-code" style="width:100px; height:100px; margin:0 auto; display:block;"></i>`, "My QR Code");
            if(type==='fav') showModalHTML(favorites.map(f=>`<div class="list-item"><span class="cat-chip">${f.cat}</span>${f.title}</div>`).join(''), "Favorites");
            if(type==='products') showModalHTML(myProducts.map(p=>`<div style="background:#f1f5f9; padding:15px; border-radius:15px; margin-bottom:10px;"><b>${p.title}</b><p>${p.desc}</p></div>`).join(''), "Products");
            if(type==='todo') showModalHTML(masterTasks.map(t=>`<div class="list-item">${t.title}</div>`).join(''), "To-Do List");
        }

        window.onload = function() { filterContent('Activity', '#3b82f6'); updateDash(); };
    </script>
</body>
</html>




