/* ==========================================================
   [1] ì „ì—­ ë°ì´í„° ë° ì´ˆê¸°í™”
   ========================================================== */
if (typeof lucide !== 'undefined') lucide.createIcons();

let todoList = [];
let favList = [];
let schedList = [];
let recData = []; // ì¶”ì²œ ë°ì´í„° ì €ì¥ì†Œ

let currentEditType = null;
let currentEditId = null;

let map = null;       // ì§€ë„ ê°ì²´
let markers = [];     // ì§€ë„ ë§ˆì»¤ ë°°ì—´

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
window.onload = function() {
    console.log("ğŸš€ ì•± ì‹œì‘! (í†µí•© ë¡œë”©)");
    
    // 1. í˜ì´ì§€ ì´ˆê¸°í™” (í™ˆ í™”ë©´ìœ¼ë¡œ)
    if(typeof navigateTo === 'function') navigateTo('home');

    // 2. DB ë¦¬ìŠ¤ë„ˆ ì—°ê²° (ë°ì´í„° ê°ì‹œ)
    initRealtimeListeners();

    // 3. ì§€ë„ ì´ˆê¸°í™”
    setTimeout(() => {
        initMap(); 
    }, 100);
};

/* ==========================================================
   [2] Firestore ì‹¤ì‹œê°„ ë™ê¸°í™” (spots ì´ë¦„í‘œ í™•ì¸ë¨)
   ========================================================== */
function initRealtimeListeners() {
    if (!window.db) {
        console.error("âŒ DB ì—°ê²° ì‹¤íŒ¨: window.dbê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    // 1. To-Do List
    window.onSnapshot(window.collection(window.db, "todos"), (snapshot) => {
        todoList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderTodoList();
        updateCounts();
    });

    // 2. Schedule List
    window.onSnapshot(window.collection(window.db, "schedules"), (snapshot) => {
        schedList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderSchedList();
        updateCounts();
    });

    // 3. Favorites List
    window.onSnapshot(window.collection(window.db, "favorites"), (snapshot) => {
        favList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderFavList();
        updateCounts();
    });

    // 4. ì¶”ì²œ ë§›ì§‘ (ì»¬ë ‰ì…˜ ì´ë¦„ recommendationsë¡œ í†µì¼)
    window.onSnapshot(window.collection(window.db, "recommendations"), (snapshot) => {
        recData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        console.log(`âœ… ë§›ì§‘ ë°ì´í„° ìˆ˜ì‹ : ${recData.length}ê°œ`);
        
        renderRecList('all');
        updateMapMarkers('all');
    });
}

function updateCounts() {
    const t = document.getElementById('count-todo');
    const f = document.getElementById('count-fav');
    const s = document.getElementById('count-sched');
    if(t) t.innerText = todoList.filter(i => !i.checked).length;
    if(f) f.innerText = favList.length;
    if(s) s.innerText = schedList.filter(i => !i.checked).length;
}

/* ==========================================================
   [3] ë°ì´í„° ì¶”ê°€/ìˆ˜ì •/ì‚­ì œ ë¡œì§ (ê¸°ì¡´ ë™ì¼)
   ========================================================== */
async function addNewTodo() {
    const input = document.getElementById('new-todo-title');
    const title = input.value.trim();
    if (!title) return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
    try {
        await window.addDoc(window.collection(window.db, "todos"), {
            title, date: "", time: "", checked: false, created: Date.now()
        });
        input.value = "";
    } catch (e) { console.error(e); }
}

async function deleteItem(collectionName, id) {
    if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    try { await window.deleteDoc(window.doc(window.db, collectionName, id)); } 
    catch (e) { console.error(e); }
}

async function toggleItem(collectionName, id, currentStatus) {
    try { await window.updateDoc(window.doc(window.db, collectionName, id), { checked: !currentStatus }); } 
    catch (e) { console.error(e); }
}

async function toggleSched(id) {
    const item = schedList.find(i => i.id === id);
    if (!item) return;
    if (item.checked) {
        if (confirm("To Do Listë¡œ ë˜ëŒë¦´ê¹Œìš”?")) {
            await window.addDoc(window.collection(window.db, "todos"), {
                title: item.title, date: new Date().toISOString().split('T')[0],
                time: item.time, checked: false, created: Date.now()
            });
            await window.deleteDoc(window.doc(window.db, "schedules", id));
        } else { toggleItem("schedules", id, true); }
    } else { toggleItem("schedules", id, false); }
}

/* ==========================================================
   [4] UI ë Œë”ë§ (ë§›ì§‘ ë¦¬ìŠ¤íŠ¸ í¬í•¨)
   ========================================================== */
function renderTodoList() {
    const list = document.getElementById('list-todo');
    if (!list) return;
    const sorted = [...todoList].sort((a,b) => (a.checked - b.checked) || b.created - a.created);
    list.innerHTML = sorted.map(item => `
        <div class="list-item ${item.checked ? 'checked' : ''}">
            <div class="list-check" onclick="toggleItem('todos', '${item.id}', ${item.checked})"><i data-lucide="check"></i></div>
            <div class="list-content" onclick="openEditPopup('todo', '${item.id}')">
                <div class="item-title">${item.title}</div>
                <div class="item-sub">${item.date || ''} ${item.time || ''}</div>
            </div>
            <button class="action-btn delete" onclick="deleteItem('todos', '${item.id}')"><i data-lucide="trash-2"></i></button>
        </div>
    `).join('');
    if(typeof lucide !== 'undefined') lucide.createIcons();
}

function renderSchedList() {
    const list = document.getElementById('list-sched');
    if (!list) return;
    const now = new Date().toTimeString().substring(0,5);
    const sorted = [...schedList].sort((a,b) => (a.checked - b.checked) || a.time.localeCompare(b.time));
    list.innerHTML = sorted.map(item => `
        <div class="list-item ${item.checked ? 'checked' : ''} ${!item.checked && item.time < now ? 'past' : ''}">
            <div class="list-check" onclick="toggleSched('${item.id}')"><i data-lucide="check"></i></div>
            <div class="list-content" onclick="openEditPopup('sched', '${item.id}')">
                <div class="item-title">${item.title}</div>
                <div class="item-sub">â° ${item.time}</div>
            </div>
            <button class="action-btn delete" onclick="deleteItem('schedules', '${item.id}')"><i data-lucide="trash-2"></i></button>
        </div>
    `).join('');
    if(typeof lucide !== 'undefined') lucide.createIcons();
}

function renderFavList() {
    const list = document.getElementById('list-fav');
    if (!list) return;
    if (favList.length === 0) list.innerHTML = "<div style='text-align:center;color:#888;'>ë¹„ì–´ìˆìŒ</div>";
    else {
        list.innerHTML = favList.map(item => `
            <div class="list-item">
                <div class="list-content">
                    <div class="item-title">${item.title}</div>
                    <div class="item-sub">${item.desc || ''}</div>
                </div>
                <button class="action-btn delete" onclick="deleteItem('favorites', '${item.id}')"><i data-lucide="trash-2"></i></button>
            </div>
        `).join('');
    }
    if(typeof lucide !== 'undefined') lucide.createIcons();
}

// ë§›ì§‘ ë¦¬ìŠ¤íŠ¸ ê·¸ë¦¬ê¸° (ì—°ë™ ì™„ë£Œ)
function renderRecList(category) {
    const list = document.getElementById('rec-list-container');
    if (!list) return; 

    const filtered = (category === 'all' || !category) 
        ? recData 
        : recData.filter(item => item.cat === category);

    list.innerHTML = filtered.map(item => `
        <div class="list-item" onclick="moveToMap('${item.title}', ${item.lat}, ${item.lng})">
            <div class="img-box" style="width: 80px; height: 80px; border-radius: 12px; overflow: hidden; margin-right: 15px; flex-shrink: 0;">
                <img src="${item.img || 'https://via.placeholder.com/80'}" style="width: 100%; height: 100%; object-fit: cover;">
            </div>
            <div class="list-content">
                <div class="item-title" style="font-weight: bold; font-size: 16px; margin-bottom: 4px;">
                    ${item.title} 
                    <span style="color: ${item.status === 'red' ? '#ff4d4f' : item.status === 'yellow' ? '#faad14' : '#52c41a'};">â—</span>
                </div>
                <div class="item-desc" style="font-size: 13px; color: #666; margin-bottom: 4px;">${item.desc || ''}</div>
                <div class="item-tags">
                    ${(item.tags || []).map(t => `<span class="tag" style="background:#f0f0f0; padding:2px 6px; border-radius:4px; font-size:11px; margin-right:4px;">#${t}</span>`).join('')}
                </div>
            </div>
        </div>
    `).join('');
}

/* ==========================================================
   [5] ì§€ë„ ì—°ë™ í•µì‹¬ ê¸°ëŠ¥
   ========================================================== */
function initMap() {
    const mapContainer = document.getElementById('map');
    if (!mapContainer || map !== null) return;

    map = L.map('map').setView([37.5665, 126.9780], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    updateMapMarkers('all');
}

function updateMapMarkers(category) {
    if (!map) return;
    markers.forEach(m => map.removeLayer(m));
    markers = [];

    const filtered = (category === 'all' || !category) 
        ? recData 
        : recData.filter(item => item.cat === category);

    filtered.forEach(item => {
        if (item.lat && item.lng) {
            const marker = L.marker([item.lat, item.lng]).addTo(map);
            marker.bindPopup(`<b>${item.title}</b><br>${item.desc || ''}`);
            markers.push(marker);
        }
    });
}

function moveToMap(title, lat, lng) {
    if (!map) return;
    map.flyTo([lat, lng], 17, { animate: true, duration: 1.5 });
    markers.forEach(m => {
        const p = m.getLatLng();
        if (Math.abs(p.lat - lat) < 0.0001) m.openPopup();
    });
}

function filterCategory(category) {
    document.querySelectorAll('.cat-btn').forEach(btn => btn.classList.remove('active'));
    const activeBtn = document.querySelector(`.cat-btn[onclick*="'${category}'"]`);
    if(activeBtn) activeBtn.classList.add('active');

    renderRecList(category);
    updateMapMarkers(category);
}

/* ==========================================================
   [6] UI ì œì–´ (íŒì—…, ë©”ë‰´, í—¬í”„íƒ­)
   ========================================================== */
function toggleHelp() {
    document.querySelector('.help-container')?.classList.toggle('open');
}

function navigateTo(pageId) {
    closeSideMenu();
    document.querySelectorAll('.page').forEach(p => {
        p.style.display = 'none';
        p.classList.remove('active');
    });
    const target = document.getElementById('page-' + pageId);
    if (target) {
        target.style.display = 'block';
        target.classList.add('active');
        updateBottomNav(pageId);
        if (pageId === 'map' && map) setTimeout(() => map.invalidateSize(), 100);
    }
}

function updateBottomNav(activePage) {
    document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active'));
    const activeBtn = document.querySelector(`.nav-item[onclick*="'${activePage}'"]`);
    if (activeBtn) activeBtn.classList.add('active');
}

function openSideMenu() {
    document.getElementById('side-menu')?.classList.add('open');
    document.getElementById('side-menu-overlay')?.classList.add('open');
}

function closeSideMenu() {
    document.getElementById('side-menu')?.classList.remove('open');
    document.getElementById('side-menu-overlay')?.classList.remove('open');
}

// ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
window.onclick = function(event) {
    const modals = ['qr-modal', 'lang-modal', 'modal-todo', 'modal-fav', 'modal-sched', 'modal-edit-popup'];
    modals.forEach(id => {
        const m = document.getElementById(id);
        if (m && event.target === m) m.style.display = "none";
    });
    const overlay = document.getElementById('side-menu-overlay');
    if (overlay && event.target === overlay) closeSideMenu();
}

// ê¸°íƒ€ íŒì—… í•¨ìˆ˜ë“¤
function openQRModal() { document.getElementById('qr-modal').style.display = 'flex'; }
function closeQRModal() { document.getElementById('qr-modal').style.display = 'none'; }
function openLangModal() { document.getElementById('lang-modal').style.display = 'flex'; }
function closeLangModal() { document.getElementById('lang-modal').style.display = 'none'; }
function openTodoModal() { renderTodoList(); openModal('modal-todo'); }
function openFavModal() { renderFavList(); openModal('modal-fav'); }
function openScheduleModal() { renderSchedList(); openModal('modal-sched'); }
function openModal(id) { document.getElementById(id).style.display='flex'; }
function closeModal(id) { document.getElementById(id).style.display='none'; }
function closeEditPopup() { document.getElementById('modal-edit-popup').style.display = 'none'; }

// í¸ì˜ìƒ ë˜í¼ í•¨ìˆ˜ë“¤
window.deleteTodo = (id) => deleteItem('todos', id);
window.deleteSched = (id) => deleteItem('schedules', id);
window.deleteFav = (id) => deleteItem('favorites', id);

// ë‚´ ìœ„ì¹˜ë¥¼ ì €ì¥í•  ë³€ìˆ˜ (ê¸°ë³¸ê°’: ì„œìš¸ì‹œì²­)
let userPos = { lat: 37.5665, lng: 126.9780 }; 
let userMarker = null; // ì§€ë„ì— í‘œì‹œë  ë‚´ ìœ„ì¹˜ ë§ˆì»¤
let userCircle = null; // 1km ë°˜ê²½ ì›

function findMyLocation() {
    if (!navigator.geolocation) {
        alert("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” GPSë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return;
    }

    // ìœ„ì¹˜ ì¶”ì  ì‹œì‘
    navigator.geolocation.getCurrentPosition(
        (position) => {
            const { latitude, longitude } = position.coords;
            userPos.lat = latitude;
            userPos.lng = longitude;

            console.log("ğŸ“ ë‚´ ìœ„ì¹˜ íŒŒì•… ì™„ë£Œ:", userPos);

            // 1) ì§€ë„ë¥¼ ë‚´ ìœ„ì¹˜ë¡œ ì´ë™
            if (map) {
                map.flyTo([latitude, longitude], 15);

                // 2) ë‚´ ìœ„ì¹˜ ë§ˆì»¤ í‘œì‹œ (íŒŒë€ìƒ‰ ì )
                updateUserMarker(latitude, longitude);
            }
        },
        (error) => {
            console.error("ìœ„ì¹˜ íŒŒì•… ì—ëŸ¬:", error);
            alert("ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”!");
        },
        { enableHighAccuracy: true } // ì •í™•ë„ ë†’ì´ê¸° ì˜µì…˜
    );
}

// ì§€ë„ì— ë‚´ ìœ„ì¹˜ ì ê³¼ 1km ì›ì„ ê·¸ë¦¬ëŠ” í•¨ìˆ˜
function updateUserMarker(lat, lng) {
    // ê¸°ì¡´ ë§ˆì»¤/ì› ì‚­ì œ
    if (userMarker) map.removeLayer(userMarker);
    if (userCircle) map.removeLayer(userCircle);

    // íŒŒë€ìƒ‰ ì›í˜• ë§ˆì»¤ (ë‚˜)
    userMarker = L.circleMarker([lat, lng], {
        radius: 8,
        fillColor: "#3b82f6",
        color: "#fff",
        weight: 2,
        fillOpacity: 1
    }).addTo(map).bindPopup("You are here!");

    // 1km ë°˜ê²½ ì› (ì—°í•œ íŒŒë€ìƒ‰)
    userCircle = L.circle([lat, lng], {
        radius: 1000, // 1000ë¯¸í„° = 1km
        color: "#3b82f6",
        fillColor: "#3b82f6",
        fillOpacity: 0.1,
        weight: 1
    }).addTo(map);
}
