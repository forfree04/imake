<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>imake ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</title>
    <link rel="stylesheet" href="https://unpkg.com/lucide@latest">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Pretendard', sans-serif; margin: 0; background: #f1f5f9; color: #333; }
        
        /* [ì‹ ê·œ] ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ìŠ¤íƒ€ì¼ */
        .admin-header { background: white; border-bottom: 1px solid #e2e8f0; padding: 0 30px; height: 64px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .logo { font-size: 20px; font-weight: 900; color: #3b82f6; display: flex; align-items: center; gap: 8px; }
        .nav-menu { display: flex; gap: 30px; height: 100%; }
        .nav-item { display: flex; align-items: center; height: 100%; cursor: pointer; font-weight: 600; color: #64748b; border-bottom: 3px solid transparent; transition: all 0.2s; font-size: 15px; }
        .nav-item:hover { color: #3b82f6; }
        .nav-item.active { color: #3b82f6; border-bottom-color: #3b82f6; }
        
        .admin-container { max-width: 1200px; margin: 30px auto; padding: 0 20px; }
        .login-box { max-width: 400px; margin: 100px auto; background: white; padding: 40px; border-radius: 16px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .dashboard { display: none; } /* ë¡œê·¸ì¸ ì „ì—ëŠ” ìˆ¨ê¹€ */
        
        .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        /* ì„¹ì…˜ íƒ€ì´í‹€ ìŠ¤íƒ€ì¼ */
        .section-header { margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .section-title { font-size: 24px; font-weight: 800; color: #1e293b; }
        
        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        input { padding: 8px; border: 1px solid #ddd; border-radius: 6px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }

        /* ë°˜ì‘í˜• ì²˜ë¦¬ */
        @media (max-width: 768px) {
            .admin-header { flex-direction: column; height: auto; padding: 15px; gap: 15px; }
            .nav-menu { width: 100%; justify-content: center; gap: 20px; border-top: 1px solid #f1f5f9; padding-top: 10px; }
            .nav-item { height: 40px; border-bottom: none; border-radius: 6px; padding: 0 10px; }
            .nav-item.active { background: #eff6ff; border-bottom: none; }
        }
    </style>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="login-view" class="login-box">
        <h2>ìµœê³  ê´€ë¦¬ì</h2>
        <p>ê´€ë¦¬ì ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”</p>
        <button class="btn btn-primary" onclick="adminLogin()">êµ¬ê¸€ ë¡œê·¸ì¸</button>
    </div>

    <!-- ëŒ€ì‹œë³´ë“œ í™”ë©´ -->
    <div id="dashboard-view" class="admin-container dashboard">
        <!-- [ì‹ ê·œ] ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
        <div class="admin-header">
            <div class="logo"><i data-lucide="shield-check"></i> imake ê´€ë¦¬ì</div>
            <div class="nav-menu">
                <div class="nav-item active" onclick="switchView('dashboard')" id="nav-dashboard">ëŒ€ì‹œë³´ë“œ</div>
                <div class="nav-item" onclick="switchView('partners')" id="nav-partners">íŒŒíŠ¸ë„ˆ ê´€ë¦¬</div>
                <div class="nav-item" onclick="switchView('users')" id="nav-users">íšŒì› ê´€ë¦¬</div>
            </div>
            <button class="btn btn-danger" onclick="adminLogout()" style="padding: 8px 16px; font-size: 13px;">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
        
        <div class="admin-container">
            <!-- 1. Dashboard View -->
            <div id="view-dashboard" class="view-section">
                <div class="section-header">
                    <div class="section-title">í˜„í™© ê°œìš”</div>
                    <div style="color:#64748b; font-size:14px;">ì˜¤ëŠ˜: <span id="today-date"></span></div>
                </div>
                
                <!-- 1. ìƒë‹¨: í•µì‹¬ ìš”ì•½ (KPI) -->
                <div class="card-grid" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); margin-bottom: 20px;">
                    <div class="card">
                        <div style="color:#64748b; font-size:14px; font-weight:bold;">ì´ íšŒì›ìˆ˜</div>
                        <div style="font-size:28px; font-weight:900; margin:5px 0;" id="kpi-users">-</div>
                        <div style="font-size:12px; color:#10b981;">â–² <span id="kpi-users-inc">0</span> (ì „ì¼ ëŒ€ë¹„)</div>
                    </div>
                    <div class="card" style="border-left: 4px solid #3b82f6;">
                        <div style="color:#3b82f6; font-size:14px; font-weight:bold;">ìœ ë£Œ íšŒì› ë¹„ìœ¨</div>
                        <div style="font-size:28px; font-weight:900; margin:5px 0;" id="kpi-paid-ratio">0%</div>
                        <div style="font-size:12px; color:#64748b;">ëª©í‘œ: 20%</div>
                    </div>
                    <div class="card">
                        <div style="color:#64748b; font-size:14px; font-weight:bold;">ì´ íŒŒíŠ¸ë„ˆ ìˆ˜</div>
                        <div style="font-size:28px; font-weight:900; margin:5px 0;" id="kpi-partners">-</div>
                        <div style="font-size:12px; color:#64748b;">ìš´ì˜ ì¤‘ì¸ ë§¤ì¥</div>
                    </div>
                    <div class="card">
                        <div style="color:#64748b; font-size:14px; font-weight:bold;">ì˜¤ëŠ˜ì˜ ê±°ë˜ì•¡</div>
                        <div style="font-size:28px; font-weight:900; margin:5px 0; color:#ef4444;">â‚© <span id="kpi-gmv">0</span></div>
                        <div style="font-size:12px; color:#64748b;">ì´ ê²°ì œ ê·œëª¨</div>
                    </div>
                </div>

                <!-- 2. ì¤‘ë‹¨: ì°¨íŠ¸ & ë¶„ì„ -->
                <div class="card-grid" style="margin-bottom: 20px;">
                    <div class="card">
                        <h3>íŒŒíŠ¸ë„ˆ ì¹´í…Œê³ ë¦¬ ë¶„í¬</h3>
                        <div style="position: relative; height: 300px; width: 100%;">
                            <canvas id="chart-category"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <h3>ì‚¬ìš©ì êµ­ì  ë¹„ìœ¨</h3>
                        <div style="position: relative; height: 300px; width: 100%;">
                            <canvas id="chart-nation"></canvas>
                        </div>
                    </div>
                </div>

                <!-- 3. í•˜ë‹¨: ìš´ì˜ (ìŠ¹ì¸ ëŒ€ê¸°) -->
                <div class="card">
                    <h3>ìŠ¹ì¸ ëŒ€ê¸° íŒŒíŠ¸ë„ˆ</h3>
                    <div id="dashboard-pending-list">Loading...</div>
                </div>
            </div>

            <!-- 2. Partners View -->
            <div id="view-partners" class="view-section" style="display:none;">
                <div class="section-header"><div class="section-title">íŒŒíŠ¸ë„ˆ ê´€ë¦¬</div></div>
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3>ì „ì²´ íŒŒíŠ¸ë„ˆ ëª©ë¡</h3>
                        <div style="display:flex; gap:10px;">
                            <button class="btn btn-primary" onclick="openPartnerModal()">+ íŒŒíŠ¸ë„ˆ ì¶”ê°€</button>
                            <button class="btn" style="background:#10b981; color:white;" onclick="triggerBulkUpload()">ğŸ“‚ ì¼ê´„ ë“±ë¡ (CSV/Excel/XML)</button>
                            <input type="file" id="bulk-upload" accept=".csv, .xlsx, .xls, .xml" style="display:none" onchange="handleBulkUpload(this)">
                        </div>
                    </div>
                    <div style="overflow-x:auto;">
                        <table style="min-width: 800px;">
                            <thead>
                                <tr><th>ì—…ì²´ëª…</th><th>ì¹´í…Œê³ ë¦¬</th><th>ì „í™”ë²ˆí˜¸</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr>
                            </thead>
                            <tbody id="partners-table-body">
                                <!-- Partner rows will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 3. Users View -->
            <div id="view-users" class="view-section" style="display:none;">
                <div class="section-header"><div class="section-title">íšŒì› ê´€ë¦¬</div></div>
                <div class="card">
                    <h3>ì „ì²´ ê°€ì… íšŒì›</h3>
                    <div id="user-list">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- [ì‹ ê·œ] íˆìŠ¤í† ë¦¬ ìƒì„¸ ëª¨ë‹¬ -->
    <div id="history-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div style="background:white; padding:20px; border-radius:12px; width:90%; max-width:500px; max-height:80vh; display:flex; flex-direction:column;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
                <h3 id="history-modal-title" style="margin:0;">íˆìŠ¤í† ë¦¬</h3>
                <button onclick="closeHistoryModal()" style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            <div id="history-modal-content" style="overflow-y:auto; flex:1;">Loading...</div>
        </div>
    </div>

    <!-- [ì‹ ê·œ] íˆìŠ¤í† ë¦¬ ìƒì„¸ ëª¨ë‹¬ -->
    <div id="history-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div style="background:white; padding:20px; border-radius:12px; width:90%; max-width:500px; max-height:80vh; display:flex; flex-direction:column;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
                <h3 id="history-modal-title" style="margin:0;">History</h3>
                <button onclick="closeHistoryModal()" style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            <div id="history-modal-content" style="overflow-y:auto; flex:1;">Loading...</div>
        </div>
    </div>

    <!-- [ì‹ ê·œ] íŒŒíŠ¸ë„ˆ ìˆ˜ë™ ë“±ë¡ ëª¨ë‹¬ -->
    <div id="partner-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div style="background:white; padding:30px; border-radius:12px; width:90%; max-width:500px;">
            <h3 id="partner-modal-title" style="margin-top:0;">ìƒˆ íŒŒíŠ¸ë„ˆ ë“±ë¡</h3>
            <input type="hidden" id="partner-id">
            <p style="color:#666; font-size:14px; margin-bottom:20px;">ë§¤ì¥ ì •ë³´ë¥¼ ì§ì ‘ ì…ë ¥í•˜ì—¬ ë“±ë¡í•©ë‹ˆë‹¤.</p>
            
            <label style="display:block; font-weight:bold; margin-bottom:5px;">ì—…ì²´ëª…</label>
            <input type="text" id="new-partner-store" placeholder="ì—…ì²´ëª…">

            <label style="display:block; font-weight:bold; margin-bottom:5px; margin-top:10px;">ì¹´í…Œê³ ë¦¬</label>
            <input type="text" id="new-partner-cat" placeholder="Food, Cafe ë“±">

            <label style="display:block; font-weight:bold; margin-bottom:5px; margin-top:10px;">ì£¼ì†Œ (ì¢Œí‘œ ìë™ ê²€ìƒ‰)</label>
            <input type="text" id="new-partner-addr" placeholder="ì£¼ì†Œ (ì˜ˆ: ì„œìš¸ ì¤‘êµ¬ ì„¸ì¢…ëŒ€ë¡œ 110)">

            <label style="display:block; font-weight:bold; margin-bottom:5px; margin-top:10px;">ì „í™”ë²ˆí˜¸</label>
            <input type="text" id="new-partner-phone" placeholder="010-xxxx-xxxx">

            <h4 style="margin-top:20px; margin-bottom:10px; border-top:1px solid #eee; padding-top:10px;">ëŒ€í‘œ ë©”ë‰´</h4>
            <input type="text" id="new-partner-menu-name" placeholder="ë©”ë‰´ëª…" style="margin-bottom:5px;">
            <input type="number" id="new-partner-menu-price" placeholder="ê°€ê²© (ì›)">

            <div style="display:flex; gap:10px; margin-top:25px;">
                <button onclick="closePartnerModal()" class="btn" style="flex:1; background:#eee;">ì·¨ì†Œ</button>
                <button onclick="savePartner()" class="btn btn-primary" style="flex:1;">íŒŒíŠ¸ë„ˆ ì €ì¥</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK ë° ì´ˆê¸°í™” -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, doc, deleteDoc, onSnapshot, setDoc, updateDoc, getDoc, getDocs, deleteField, query, where, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // index.htmlê³¼ ë™ì¼í•œ ì„¤ì • ì‚¬ìš©
        const firebaseConfig = { apiKey: "AIzaSyAonpP6itJ9_vMlAQm-0oC-fqmhlYMReE4", authDomain: "imake-master.firebaseapp.com", projectId: "imake-master", storageBucket: "imake-master.firebasestorage.app", messagingSenderId: "612892096078", appId: "1:612892096078:web:5a573c1a0dceb525eaf51f" };
        const app = initializeApp(firebaseConfig);
        
        // sscript.jsì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ window ê°ì²´ì— í• ë‹¹
        window.auth = getAuth(app); window.db = getFirestore(app); window.provider = new GoogleAuthProvider();
        window.signInWithPopup = signInWithPopup; window.signOut = signOut; window.onAuthStateChanged = onAuthStateChanged;
        window.collection = collection; window.doc = doc; window.setDoc = setDoc; window.deleteDoc = deleteDoc; window.onSnapshot = onSnapshot; window.updateDoc = updateDoc; window.getDoc = getDoc; window.getDocs = getDocs; window.deleteField = deleteField; window.query = query; window.where = where; window.addDoc = addDoc;
    </script>
    <script src="sscript.js" defer></script>
</body>
</html>